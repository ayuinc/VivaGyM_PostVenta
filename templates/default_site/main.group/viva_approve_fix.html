{embed="includes/header"}
{embed="includes/carga" }

<?php
$id_sol_garantia=$_POST['id_sol_garantia'];
$id_cliente=$_POST['id_cliente'];
$acc=$_POST['aprobar_paso'];
$paso="6";
$dir=$_POST['dir'];
$comentarios=$_POST['comentarios'];

$result=mysql_query("SELECT * FROM exp_freeform_form_entries_2 WHERE entry_id=$id_sol_garantia");
$obten=mysql_fetch_row($result);
$id_cliente = $obten[2];
$tit_problema = $obten[15];

// leer email cuando lo tomas de ee no funca
	$result_email=mysql_query("SELECT * FROM exp_members WHERE member_id=$id_cliente");
	$obten_email=mysql_fetch_row($result_email);
	$screen_name = $obten_email[3];
	$dir = $obten_email[9];

$ant_paso=$paso-1;

$prox_paso=$paso+1;

if($paso=="2") { $mensaje="Agendar Inspección";};

if($paso=="6") { $mensaje="Agendar Arreglo";};

$ip=$_SERVER["REMOTE_ADDR"];

$date = date_create();
$entry_date=date_timestamp_get($date);

$sqlUpdate = mysql_query("UPDATE exp_freeform_form_entries_4 
SET status = 'closed'
WHERE form_field_18 = $id_sol_garantia AND form_field_19 = $paso ");

if ($acc=="si"){

$sqlUpdate = mysql_query("UPDATE exp_freeform_form_entries_4 
SET form_field_27 = 'Aprobado',
entry_date = '$entry_date',
form_field_29 = '$comentarios'
WHERE form_field_18 = $id_sol_garantia AND form_field_19 = $paso ");

$resultado=mysql_query("insert into exp_freeform_form_entries_4 
(site_id,author_id,complete,ip_address,entry_date,status,form_field_5,form_field_17,form_field_18,form_field_19) 
values ('1','$id_cliente','y','$ip','','open','$id_cliente','$mensaje','$id_sol_garantia','$prox_paso')");

// caso si pasas el ticket a "Inspección pendiente" sino lo cierras
$sqlUpdate = mysql_query("UPDATE exp_freeform_form_entries_2 
SET form_field_12 = '3'
WHERE entry_id = $id_sol_garantia ");

} elseif ($acc=="no"){ 

$sqlUpdate = mysql_query("UPDATE exp_freeform_form_entries_4 
SET form_field_27 = 'Rechazado',
status = 'closed',
entry_date = '$entry_date',
form_field_29 = '$comentarios'
WHERE form_field_18 = $id_sol_garantia AND form_field_19 = $paso ");

// caso si pasas el ticket a "Inspección pendiente" sino lo cierras
$sqlUpdate = mysql_query("UPDATE exp_freeform_form_entries_2 
SET form_field_12 = '4',
status = 'closed'
WHERE entry_id = $id_sol_garantia ");

}

?>

{exp:get_post_vars parse="inward"}
	{exp:user:stats dynamic="off" member_id="{post_id_cliente}"}
		{exp:mandrillapp:send_email_viva_approve_fix 
		  to='{email}'
		  name='{screen_name}'
		  from="admin@gym.com"
		  acc="{post_aprobar_paso}"
		  id_sol_garantia="{post_id_sol_garantia}"
		  comentarios="{post_comentarios}" }
		{/exp:mandrillapp:send_email_viva_approve_fix}
	{/exp:user:stats}   
{/exp:get_post_vars}

<body>

<?php
// dormir durante 10 segundos
sleep(10);
?>

<script type="text/javascript">
window.location="{site_url}main/admin_dashboard";
</script>

</body>